<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body></body>

 
  <script>
    const bucket = new WeakMap();
    let activeEffect = null; // 用一个全局变量存储被注册的副作用函数
    // 注册副作用函数
    const effect = (fn) => {
      const effectFn = () => {
        cleanup(effectFn);
        activeEffect = effectFn;
        fn();
      }
      effectFn.deps = []; // 存储所有与该副作用函数相关的依赖集合
      effectFn(); // 执行副作用函数
    };

    function cleanup(effectFn) {
      // 删除 Set 元素
       for (let i = 0; i < effectFn.deps.length; i++){
        effectFn.deps[i].delete(effectFn);
      }
      effectFn.deps.length = 0; // 最后需要重置 effectFn.deps 数组
    }

    // 原始数据
    var data = { text: "Hello World", ok: true };

    // 数据代理
    let obj = new Proxy(data, {
      get(target, key) {
        track(target, key);
        return target[key];
      },
      set(target, key, newVal) {
        target[key] = newVal;
        trigger(target, key);
        return true;
      },
    });

    // 追踪属性的变化
    function track(target, key) {
      if (activeEffect) {
        let depsMap = bucket.get(target);
        if (!depsMap) {
          bucket.set(target, (depsMap = new Map()));
        }

        // 获取 key 属性对应的副作用函数
        let deps = depsMap.get(key);
        if (!deps) {
          depsMap.set(key, (deps = new Set()));
        }
        deps.add(activeEffect);
        activeEffect.deps.push(deps);
      }
    }

    // 拦截属性的变化，并做出反应
    function trigger(target, key) {
      const depsMap = bucket.get(target);
      if (depsMap) {
        const effects = depsMap.get(key);
        const effectsToRun = new Set(effects)
        effectsToRun.forEach(effectFn => {
          effectFn()
        }) 
      }
    }
    // 副作用函数
    effect(() => {
      document.body.innerText = obj.ok ? obj.text : "not";
    });
    
    obj.ok = false 

    // 修改数据
    setTimeout(() => {
      console.log(bucket, "bucket")
      obj.text = "Hello Vue3"; // 问题： obj.ok == false 的时候，修改 text 属性，不会触发副作用函数才对
    }, 1000);
  </script>
</html>
